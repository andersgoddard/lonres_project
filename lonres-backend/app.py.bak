from flask import Flask, request, jsonify
import logging
import os
from datetime import datetime
import json
import traceback

app = Flask(__name__)

# Configure logging
logging.basicConfig(level=logging.INFO)

@app.route('/')
def home():
    return "Flask app is running", 200

@app.route('/receive', methods=['POST'])
def receive_data():
    if not request.is_json:
        return jsonify({"error": "Request content-type must be application/json"}), 415

    try:
        data = request.get_json(silent=True)
        if not data:
            return jsonify({"error": "Empty or invalid JSON body"}), 400

        DATA_DIR = "/tmp/received_data"
        os.makedirs(DATA_DIR, exist_ok=True)  # ✅ Ensure the directory exists

        filename = datetime.now().strftime("%Y%m%d_%H%M%S.json")
        filepath = os.path.join(DATA_DIR, filename)

        with open(filepath, 'w') as f:
            json.dump(data, f, indent=2)

        logging.info(f"✅ Data received and saved to {filepath}")
        return jsonify({"message": "Data received successfully"}), 200

    except Exception as e:
        logging.error("Error processing request:")
        logging.error(traceback.format_exc())
        return jsonify({"error": "Internal server error"}), 500

@app.route("/entries", methods=["GET"])
def get_entries():
    return jsonify(load_data())

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port, debug=True)
